<html><head><meta charSet="utf-8"/><title data-react-helmet="true">查询构造器 · WorkerA 1.1 文档  · 看云</title><meta data-react-helmet="true" name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/><link rel="stylesheet" href="asset/website.css"/></head><body><div id="main"><div class="root"><div class="window-container"><div class="window-head"><div class="toolbar"><a class="title" href=".">WorkerA 1.1 文档</a><div class="extra"></div></div></div><div class="progress"><div style="width:89.47368421052632%" class="progress-bar"></div></div><div class="window-body"><div class="sidebar"><div class="sidebar-selector"><div class="item active"><i class="icon content"></i>目录</div><div class="item"><i class="icon search"></i>搜索</div></div><div class="sidebar-body"><div class="catalog-body active"><ul><li class=""><div class="wholerow"></div><i class="icon"></i><a href="前言.html" class="text">前言</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="版本说明.html" class="text">版本说明</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="旧版本升级.html" class="text">旧版本升级</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="框架性能.html" class="text">框架性能</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="框架结构说明.html" class="text">目录结构、程序架构</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="配置、安装.html" class="text">配置、安装</a></li><li class=""><div class="wholerow"></div><i class="icon caret right"></i><a href="基本使用.html" class="text">基本使用</a><ul><li class=""><div class="wholerow"></div><i class="icon"></i><a href="开始.html" class="text">开始</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="路由.html" class="text">路由</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="控制器.html" class="text">控制器</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="中间件.html" class="text">中间件</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="请求.html" class="text">请求</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="响应.html" class="text">响应</a></li></ul></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="异常处理.html" class="text">异常处理</a></li><li class="open"><div class="wholerow"></div><i class="icon caret down"></i><a href="数据库.html" class="text">数据库</a><ul><li class=""><div class="wholerow"></div><i class="icon"></i><a href="数据库配置.html" class="text">数据库配置</a></li><li class="active"><div class="wholerow"></div><i class="icon"></i><a href="查询构造器.html" class="text">查询构造器</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="模型.html" class="text">模型</a></li><li class=""><div class="wholerow"></div><i class="icon"></i><a href="Redis.html" class="text">Redis</a></li></ul></li></ul></div><div class="search-body"><div class="search-form"><form class="ui form"><div class="ui small fluid icon input"><input type="text" placeholder="请输入搜索关键词..."/><i class="search icon"></i></div></form></div><div class="search-result"><div class="blankslate"><i class="icon search"></i><p>暂无相关搜索结果！</p></div></div></div></div><div class="sidebar-copyright">本文档使用 <a href="http://www.kancloud.cn" target="_blank">看云</a> 构建</div></div><div class="workspace"><div class="article-wrap"><div class="article"><div class="article-head"><div class="left floated tools"><a class="item icon"><i class="icon align justify"></i></a></div><div class="right floated tools"></div><h1>查询构造器</h1></div><div class="article-body"><p>目录</p>
<div class="markdown-toc"><ul><ul><li><a href="#_8">获取结果</a></li><ul><li><a href="#_12">获取结果集</a></li><li><a href="#_24">获取一行数据</a></li><li><a href="#_39">获取一列</a></li><li><a href="#_49">聚合函数</a></li></ul><li><a href="#where__61">where 子句</a></li><li><a href="#_where__132">复杂 where 子句</a></li><li><a href="#_185">子查询</a></li><li><a href="#_199">分组</a></li><li><a href="#_233">排序</a></li><li><a href="#limit_245">limit</a></li><li><a href="#_256">分页</a></li><li><a href="#_283">关联</a></li><li><a href="#_308">构造复杂的语句</a></li><li><a href="#DML__382">DML 语句</a></li><ul><li><a href="#_386">插入</a></li><li><a href="#_413">更新</a></li></ul><li><a href="#_432">删除</a></li><li><a href="#_446">事务</a></li></ul></ul></div><p>数据库查询构造器为 SQL 的构造和执行提供了方便的接口。WorkerA 提供了一个好用的查询构造器，基于 PDO，支持链式操作。</p>
<p>支持的数据库有 mysql、postgresql、sqlite，支持断线重连。</p>
<h2 data-line="8" class="line"><a id="_8"></a>获取结果</h2>
<p>获取结果的方法有：get，row，getList，count，sum，avg，max，min。参数等信息参考 <a href="https://github.com/wazsmwazsm/WorkerF/blob/master/src/WorkerF/DB/Drivers/ConnectorInterface.php" target="_blank">ConnectorInterface</a>。</p>
<h3 data-line="12" class="line"><a id="_12"></a>获取结果集</h3>
<p>table 方法用来指定查询的数据表。</p>
<p>get 方法用来获取结果集，返回值是一个查询结果的数组。</p>
<pre><code class="language-php">// SELECT * FROM test;
$data = DB::connection(&#x27;con1&#x27;)-&gt;table(&#x27;test&#x27;)-&gt;get();
</code></pre>
<h3 data-line="24" class="line"><a id="_24"></a>获取一行数据</h3>
<p>select 方法用来指定要取的列，select(&#x27;*&#x27;) 代表取所有列 (此时 select 可以省略不写)。</p>
<p>row 方法用来获取一行数据。</p>
<pre><code class="language-php">// SELECT id, name, age, score FROM test WHERE id = 10;
$row = DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;test&#x27;)
        -&gt;select(&#x27;id&#x27;, &#x27;name&#x27;, &#x27;age&#x27;, &#x27;score&#x27;)
        -&gt;where(&#x27;id&#x27;, 10)
        -&gt;row();
</code></pre>
<h3 data-line="39" class="line"><a id="_39"></a>获取一列</h3>
<p>有时候我们需要获得某一列的数据，这时 getList 方法就派上用场了，getList 方法直接返回该列值的数组。</p>
<pre><code class="language-php">// 获取 name 字段的结果集
// SELECT name FROM test;
$data = DB::connection(&#x27;con1&#x27;)-&gt;table(&#x27;test&#x27;)-&gt;getList(&#x27;name&#x27;);
</code></pre>
<h3 data-line="49" class="line"><a id="_49"></a>聚合函数</h3>
<p>查询构造器为获取聚合函数的结果做了封装，你可以使用 count，sum 等方法获取聚合数据。</p>
<pre><code class="language-php">// 获取查询结果的条数
// SELECT COUNT(*) FROM test;
$data = DB::connection(&#x27;con1&#x27;)-&gt;table(&#x27;test&#x27;)-&gt;count(*);
// 获取 score 的总和
// SELECT SUM(score) FROM test;
$data = DB::connection(&#x27;con1&#x27;)-&gt;table(&#x27;test&#x27;)-&gt;sum(&#x27;score&#x27;);
</code></pre>
<h2 data-line="61" class="line"><a id="where__61"></a>where 子句</h2>
<p>构建 where 子句的方法有 where、orWhere。</p>
<p>where 、orWhere 方法的参数支持三种模式：</p>
<ul><li>where([&#x27;name&#x27; =&gt; &#x27;mike&#x27;, &#x27;age&#x27; =&gt; 18])</li><li>where(&#x27;age&#x27;, 24)</li><li>where(&#x27;score&#x27;, &#x27;&gt;=&#x27;, 60)、where(&#x27;tag&#x27;, &#x27;like&#x27;, &#x27;%php%&#x27;)</li></ul>
<p>一些常用的例子：</p>
<pre><code class="language-php">// SELECT * FROM test WHERE name = &#x27;mike&#x27; AND age = 18;
$data = DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;test&#x27;)
        -&gt;where([
        	&#x27;name&#x27; =&gt; &#x27;mike&#x27;, 
            &#x27;age&#x27; =&gt; 18
        ])
        -&gt;get();

// SELECT * FROM test WHERE name = &#x27;jack&#x27; AND age &gt;= 18;
$data = DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;test&#x27;)
        -&gt;where(&#x27;name&#x27;, &#x27;jack&#x27;)
        -&gt;where(&#x27;age&#x27;, &#x27;&gt;=&#x27;,  18)
        -&gt;get();
// SELECT * FROM test WHERE name = &#x27;jack&#x27; OR name = &#x27;mike&#x27;;
$data = DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;test&#x27;)
        -&gt;where(&#x27;name&#x27;, &#x27;jack&#x27;)
        -&gt;orWhere(&#x27;name&#x27;, &#x27;mike&#x27;)
        -&gt;get();
</code></pre>
<p>对于 null 的条件查询，查询构造器提供了 whereNull、whereNotNull 等方法：</p>
<pre><code class="language-php">// SELECT * FROM test WHERE name IS NOT null;
$data = DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;test&#x27;)
        -&gt;whereNotNull(&#x27;name&#x27;)
        -&gt;get();
</code></pre>
<blockquote class="default"><p>注：where is null 子句的构造提供 whereNull、orWhereNull、whereNotNull、orWhereNotNull 四个方法。</p></blockquote>
<p>where between 子句：</p>
<pre><code class="language-php">// SELECT * FROM test WHERE age BETWEEN 18 AND 30;
$data = DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;test&#x27;)
        -&gt;whereBetween(&#x27;age&#x27;, 18, 30)
        -&gt;get();
</code></pre>
<blockquote class="default"><p>注：where between 子句的构造提供 whereBetween、orWhereBetween 个方法。</p></blockquote>
<p>where in 子句：</p>
<pre><code class="language-php">// SELECT * FROM test WHERE age IN (18, 19, 20);
$data = DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;test&#x27;)
        -&gt;whereIn(&#x27;age&#x27;, [18, 19, 20])
        -&gt;get();
</code></pre>
<blockquote class="default"><p>注：where in 子句的构造提供 whereIn、orWhereIn、whereNotIn、orWhereNotIn 四个方法。</p></blockquote>
<h2 data-line="132" class="line"><a id="_where__132"></a>复杂 where 子句</h2>
<p>where exists 子句：</p>
<pre><code class="language-php">// SELECT * FROM user WHERE EXISTS ( SELECT * FROM user_group WHERE id = 3 ) AND g_id = 3;
$data = DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;user&#x27;)
        -&gt;whereExists(function($query) {
            $query-&gt;table(&#x27;user_group&#x27;)-&gt;where(&#x27;id&#x27;, 3);
        })
        -&gt;where(&#x27;g_id&#x27;, 3)
        -&gt;get();
</code></pre>
<blockquote class="default"><p>注：where exists 子句的构造提供 whereExists、orWhereExists、whereNotExists、orWhereNotExists 四个方法。</p></blockquote>
<p>where in 子查询：</p>
<pre><code class="language-php">// SELECT * FROM user WHERE g_id IN (SELECT id FROM user _group);
$data = DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;user&#x27;)
        -&gt;whereInSub(&#x27;g_id&#x27;, function($query) {
            $query-&gt;table(&#x27;user_group&#x27;)-&gt;select(&#x27;id&#x27;);
        })
        -&gt;get();
</code></pre>
<blockquote class="default"><p>注：where in 子查询的构造提供 whereInSub、orWhereInSub、whereNotInSub、orWhereNotInSub 四个方法。</p></blockquote>
<p>对于复杂的 where 逻辑，我们经常使用圆括号来确定优先级。查询构造器提供了 whereBrackets() 和 orWwhereBrackets() 方法来添加圆括号。</p>
<pre><code class="language-php">// SELECT * FROM user WHERE (id &lt; 50 OR username IS NOT NULL) AND sort_num = 20;
$data = DB::connection(&#x27;con1&#x27;)
        -&gt;table(&#x27;user&#x27;)
        -&gt;whereBrackets(function($query) {
            $query-&gt;where(&#x27;id&#x27;, &#x27;&lt;&#x27;, 50)
                  -&gt;orWhereNotNull(&#x27;username&#x27;);
        })
        -&gt;where(&#x27;sort_num&#x27;, 20)
        -&gt;get();
        
// SELECT * FROM user WHERE sort_num = 20 OR (id &lt; 10 AND id &gt; 5);
$data = DB::connection(&#x27;con1&#x27;)
        -&gt;table(&#x27;user&#x27;)
        -&gt;where(&#x27;sort_num&#x27;, 20)
        -&gt;orWhereBrackets(function($query) {
            $query-&gt;where(&#x27;id&#x27;, &#x27;&lt;&#x27;, 10)
                  -&gt;where(&#x27;id&#x27;, &#x27;&gt;&#x27;, 5);
        })
        -&gt;get();
</code></pre>
<h2 data-line="185" class="line"><a id="_185"></a>子查询</h2>
<p>查询构造器提供了 fromSub 方法进行子查询：</p>
<pre><code class="language-php">// SELECT id, username, email FROM ( SELECT * FROM user WHERE id &lt; 20 ) AS tb;
$data = DB::connection(&#x27;con1&#x27;)
		-&gt;select(&#x27;id&#x27;, &#x27;username&#x27;, &#x27;email&#x27;)
        -&gt;fromSub(function($query) {
            $query-&gt;table(&#x27;user&#x27;)-&gt;where(&#x27;id&#x27;, &#x27;&lt;&#x27;, &#x27;20&#x27;);
        })
        -&gt;get();
</code></pre>
<h2 data-line="199" class="line"><a id="_199"></a>分组</h2>
<p>查询构造器提供了 group 方法对字段进行分组，having (orHaving) 方法进行分组条件筛选。</p>
<p>having 方法和 where 方法一样支持三种参数模式，这里就不再赘述。</p>
<pre><code class="language-php">// SELECT sort_num, COUNT(sort_num) FROM user GROUP BY sort_num;
$data = DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;user&#x27;)
        -&gt;select(&#x27;sort_num&#x27;, &#x27;COUNT(sort_num)&#x27;)
        -&gt;groupBy(&#x27;sort_num&#x27;)
        -&gt;get();
        
// SELECT sort_num, COUNT(sort_num) FROM user GROUP BY sort_num HAVING COUNT(sort_num) &lt; 20;
$data = DB::connection(&#x27;con1&#x27;)
        -&gt;table(&#x27;user&#x27;)
        -&gt;select(&#x27;sort_num&#x27;, &#x27;COUNT(sort_num)&#x27;)
        -&gt;groupBy(&#x27;sort_num&#x27;)
        -&gt;having(&#x27;COUNT(sort_num)&#x27;, &#x27;&lt;&#x27;, 20)
        -&gt;get();
</code></pre>
<p>查询构造器还提供了一个输入原生字符串的 havingRaw 方法，可以处理一些复杂的情况：</p>
<pre><code class="language-php">// SELECT sort_num, COUNT(sort_num) FROM user GROUP BY sort_num HAVING COUNT(sort_num) &lt; 20;
$data = DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;user&#x27;)
        -&gt;select(&#x27;sort_num&#x27;, &#x27;COUNT(sort_num)&#x27;)
        -&gt;groupBy(&#x27;sort_num&#x27;)
        -&gt;havingRaw(&#x27;COUNT(sort_num) &lt; 20&#x27;)
        -&gt;get();
</code></pre>
<h2 data-line="233" class="line"><a id="_233"></a>排序</h2>
<p>查询构造器提供了 orderBy 方法对查询结果排序：</p>
<pre><code class="language-php">// SELECT * FROM user ORDER BY sort_num DESC, id ASC;
$data = DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;user&#x27;)
        -&gt;orderBy(&#x27;sort_num&#x27;, &#x27;DESC&#x27;)
        -&gt;orderBy(&#x27;id&#x27;, &#x27;ASC&#x27;)
        -&gt;get();
</code></pre>
<h2 data-line="245" class="line"><a id="limit_245"></a>limit</h2>
<p>查询构造器提供了 limit 方法来取一定范围的数据：</p>
<pre><code class="language-php">// SELECT * FROM user LIMIT 10 OFFSET 3
$data = DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;user&#x27;)
        -&gt;limit(3, 10)
        -&gt;get();
</code></pre>
<h2 data-line="256" class="line"><a id="_256"></a>分页</h2>
<p>查询构造器提供了 paginate 方法实现了数据的分页读取，底层基于 limit 方法。</p>
<p>假设有 35 条数据，每页有 10 条数据，我们取第 2 页的数据，做如下查询：</p>
<pre><code class="language-php">$data = DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;user&#x27;)
        -&gt;paginate(10, 2);  // 每页 10 条数据，当前第 2 页
</code></pre>
<p>paginate 方法返回结果：</p>
<pre><code class="language-php">[
	&#x27;total&#x27;        =&gt; 35;
    &#x27;per_page&#x27;     =&gt; 10;
    &#x27;current_page&#x27; =&gt; 2;
    &#x27;next_page&#x27;    =&gt; 3;
    &#x27;prev_page&#x27;    =&gt; 1;
    &#x27;first_page&#x27;   =&gt; 1;
    &#x27;last_page&#x27;    =&gt; 4;
    &#x27;data&#x27;         =&gt; $yourdata;
]
</code></pre>
<h2 data-line="283" class="line"><a id="_283"></a>关联</h2>
<p>查询构造器提供了 join、leftJoin、rightJoin 三个方法来实现关联查询的构造。</p>
<blockquote class="default"><p>注：<br/>
使用关联查询后，防止字段重名字段需要带表前缀。<br/>
sqlite 不支持 RIGHT JOIN 语言，rightJoin 方法在 sqlite 中不生效。</p></blockquote>
<p>一些例子：</p>
<pre><code class="language-php">// SELECT * FROM user INNER JOIN user_group ON user.g_id = user_group.id;
$data = DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;user&#x27;)
        -&gt;join(&#x27;user_group&#x27;, &#x27;user.g_id&#x27;, &#x27;user_group.id&#x27;)
        -&gt;get();
        
        
// SELECT user.username, user_group.groupname FROM user LEFT JOIN user_group ON user.g_id = user_group.id;
$data = DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;user&#x27;)
        -&gt;select(&#x27;user.username&#x27;, &#x27;user_group.groupname&#x27;)
        -&gt;leftJoin(&#x27;user_group&#x27;, &#x27;user.g_id&#x27;, &#x27;user_group.id&#x27;)
        -&gt;get();
</code></pre>
<h2 data-line="308" class="line"><a id="_308"></a>构造复杂的语句</h2>
<p>查询构造器提供了灵活的接口，有了上面的基础，我们现在构造一些复杂的查询：</p>
<pre><code class="language-php">// SELECT user.username, user_group.groupname FROM user 
// LEFT JOIN user_group ON user.g_id = user_group.id 
// WHERE username = &#x27;Jackie aa&#x27; 
// OR ( NOT EXISTS ( SELECT * FROM user WHERE username = &#x27;Jackie aa&#x27; ) AND username = &#x27;Jackie Conroy&#x27; );
$data = DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;user&#x27;)
        -&gt;select(&#x27;user.username&#x27;, &#x27;user_group.groupname&#x27;)
        -&gt;leftJoin(&#x27;user_group&#x27;, &#x27;user.g_id&#x27;, &#x27;user_group.id&#x27;)
        -&gt;where(&#x27;user.username&#x27;, &#x27;Jackie aa&#x27;)
        -&gt;orWhereBrackets(function($query) {
            $query-&gt;whereNotExists(function($query) {
                $query-&gt;table(&#x27;user&#x27;)-&gt;where(&#x27;username&#x27;, &#x27;Jackie aa&#x27;);
            })-&gt;where(&#x27;user.username&#x27;, &#x27;Jackie Conroy&#x27;);
        })
        -&gt;get();

// SELECT user.sort_num, COUNT(*) FROM user 
// INNER JOIN user_group ON user.g_id = user_group.id 
// WHERE user.activated &lt;&gt; 0 
// GROUP BY user.sort_num 
// HAVING user.sort_num = 20 OR user.sort_num = 50 ORDER BY user.sort_num DESC;
$data = DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;user&#x27;)
        -&gt;select(&#x27;user.sort_num&#x27;, &#x27;COUNT(*)&#x27;)
        -&gt;join(&#x27;user_group&#x27;, &#x27;user.g_id&#x27;, &#x27;user_group.id&#x27;)
        -&gt;where(&#x27;user.activated&#x27;, &#x27;&lt;&gt;&#x27;, 0)
        -&gt;groupBy(&#x27;user.sort_num&#x27;)
        -&gt;having(&#x27;user.sort_num&#x27;, &#x27;50&#x27;)
        -&gt;orHaving(&#x27;user.sort_num&#x27;, &#x27;20&#x27;)
        -&gt;orderBy(&#x27;user.sort_num&#x27;, &#x27;DESC&#x27;)
        -&gt;get();

// SELECT user.username, user_group.groupname, company.companyname FROM company 
// LEFT JOIN user_group ON user_group.c_id = company.id 
// LEFT JOIN user ON user.g_id = user_group.id 
// ORDER BY user.sort_num ASC, user.id DESC LIMIT 25 offset 10;
$data = DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;user&#x27;)
        -&gt;select(&#x27;user.username&#x27;, &#x27;user_group.groupname&#x27;, &#x27;company.companyname&#x27;)
        -&gt;leftJoin(&#x27;user_group&#x27;, &#x27;user_group.c_id&#x27;, &#x27;company.id&#x27;)
        -&gt;leftJoin(&#x27;user&#x27;, &#x27;user.g_id&#x27;, &#x27;user_group.id&#x27;)
        -&gt;orderBy(&#x27;user.sort_num&#x27;, &#x27;ASC&#x27;)
        -&gt;orderBy(&#x27;user.id&#x27;, &#x27;DESC&#x27;)
        -&gt;limit(10, 25)
        -&gt;get();
        
// SELECT * FROM user 
// WHERE username = &#x27;Jackie aa&#x27; 
// OR ( NOT EXISTS ( SELECT * FROM user WHERE username = &#x27;Jackie aa&#x27; ) AND (username = &#x27;Jackie Conroy&#x27; OR username = &#x27;Jammie Haag&#x27;) ) 
// AND g_id IN ( SELECT id FROM user_group) ORDER BY id DESC LIMIT 1 OFFSET 0 ;
$data = DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;user&#x27;)
        -&gt;where(&#x27;username&#x27;, &#x27;Jackie aa&#x27;)
        -&gt;orWhereBrackets(function($query) {
            $query-&gt;whereNotExists(function($query) {
                $query-&gt;table(&#x27;user&#x27;)-&gt;where(&#x27;username&#x27;, &#x27;Jackie aa&#x27;);
            })-&gt;WhereBrackets(function($query) {
                $query-&gt;where(&#x27;username&#x27;, &#x27;Jackie Conroy&#x27;)
                      -&gt;orWhere(&#x27;username&#x27;, &#x27;Jammie Haag&#x27;);
            });
        })
        -&gt;whereInSub(&#x27;g_id&#x27;, function($query) {
            $query-&gt;table(&#x27;user_group&#x27;)-&gt;select(&#x27;id&#x27;);
        })
        -&gt;orderBy(&#x27;id&#x27;, &#x27;DESC&#x27;)
        -&gt;limit(0, 1)
        -&gt;get();
</code></pre>
<h2 data-line="382" class="line"><a id="DML__382"></a>DML 语句</h2>
<p>除了基本的查询，查询构造器还提供了基础的 DML 操作，如插入、跟新、删除。</p>
<h3 data-line="386" class="line"><a id="_386"></a>插入</h3>
<p>insert 方法：</p>
<pre><code class="language-php">// INSERT INTO user (id, name, age) VALUES (5, &#x27;jack&#x27;, 18)
$insert_data = [
  &#x27;id&#x27;   =&gt; 5,
  &#x27;name&#x27; =&gt; &#x27;jack&#x27;,
  &#x27;age&#x27;  =&gt; 18,
];
// 默认返回受影响行数
$effect_row = DB::connection(&#x27;con1&#x27;)-&gt;table(&#x27;user&#x27;)-&gt;insert($insert_data);
</code></pre>
<p>获取插入 ID，insertGetLastId 方法：</p>
<pre><code class="language-php">// INSERT INTO user (id, name, age) VALUES (5, &#x27;jack&#x27;, 18)
$insert_data = [
  &#x27;id&#x27;   =&gt; 5,
  &#x27;name&#x27; =&gt; &#x27;jack&#x27;,
  &#x27;age&#x27;  =&gt; 18,
];
// 默认插入行的 id
$effect_row = DB::connection(&#x27;con1&#x27;)-&gt;table(&#x27;user&#x27;)-&gt;insertGetLastId($insert_data);
</code></pre>
<h3 data-line="413" class="line"><a id="_413"></a>更新</h3>
<p>update 方法。</p>
<blockquote class="default"><p>注：为了安全考虑，update 方法必须要和 where 子句一起使用，否则会抛出 InvalidArgumentException 异常。</p></blockquote>
<pre><code class="language-php">//  UPDATE user SET name = &#x27;mike&#x27;, age = 23 WHERE name = &#x27;jack&#x27;;
$update_data = [
  &#x27;name&#x27; =&gt; &#x27;mike&#x27;,
  &#x27;age&#x27;  =&gt; 23,
];
// 默认返回受影响行数
$effect_row = DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;user&#x27;)
        -&gt;where(&#x27;name&#x27;, &#x27;jack&#x27;)
        -&gt;update($update_data);
</code></pre>
<h2 data-line="432" class="line"><a id="_432"></a>删除</h2>
<p>delete 方法。</p>
<blockquote class="default"><p>注：为了安全考虑，delete 方法必须要和 where 子句一起使用，否则会抛出 InvalidArgumentException 异常。</p></blockquote>
<pre><code class="language-php">// DELETE FROM user WHERE id = 1;
$effect_row = DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;user&#x27;)
        -&gt;where(&#x27;id&#x27;, 1)
        -&gt;delete();
</code></pre>
<h2 data-line="446" class="line"><a id="_446"></a>事务</h2>
<p>查询构造器提供了 beginTrans、commitTrans、rollBackTrans 三个方法来支持事务：</p>
<p>事务回滚：</p>
<pre><code class="language-php">// 开始事务
DB::connection(&#x27;con1&#x27;)-&gt;beginTrans();
// DML 操作
DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;user&#x27;)
        -&gt;where(&#x27;id&#x27;, 1)
        -&gt;delete(); 
回滚事务
DB::connection(&#x27;con1&#x27;)-&gt;rollBackTrans();
</code></pre>
<p>提交事务：</p>
<pre><code class="language-php">// 开始事务
DB::connection(&#x27;con1&#x27;)-&gt;beginTrans();
// DML 操作
DB::connection(&#x27;con1&#x27;)
		-&gt;table(&#x27;user&#x27;)
        -&gt;where(&#x27;id&#x27;, 1)
        -&gt;delete(); 
提交事务
DB::connection(&#x27;con1&#x27;)-&gt;commitTrans();
</code></pre>
 </div><div class="article-navigation"><span class="prev">上一篇：<a href="数据库配置.html">数据库配置</a></span><span class="next">下一篇：<a href="模型.html">模型</a></span></div></div></div></div></div></div></div></div><script src="asset/website.js"></script><script src="asset/plugins/highlight/index.js"></script><script type="application/payload+json">{"config":{"plugins":["highlight"],"price":0,"name":"wazsmwazsm/workera","sha":"0394c7aad780584659700053d4efaba1f4d43a76","title":"WorkerA 1.1 文档","id":70629},"catalog":[{"id":"前言.html","name":"前言.md","title":"前言","depth":1},{"id":"版本说明.html","name":"版本说明.md","title":"版本说明","depth":1},{"id":"旧版本升级.html","name":"旧版本升级.md","title":"旧版本升级","depth":1},{"id":"框架性能.html","name":"框架性能.md","title":"框架性能","depth":1},{"id":"框架结构说明.html","name":"框架结构说明.md","title":"目录结构、程序架构","depth":1},{"id":"配置、安装.html","name":"配置、安装.md","title":"配置、安装","depth":1},{"id":"基本使用.html","name":"基本使用.md","title":"基本使用","depth":1,"children":[{"id":"开始.html","name":"开始.md","title":"开始","depth":2},{"id":"路由.html","name":"路由.md","title":"路由","depth":2},{"id":"控制器.html","name":"控制器.md","title":"控制器","depth":2},{"id":"中间件.html","name":"中间件.md","title":"中间件","depth":2},{"id":"请求.html","name":"请求.md","title":"请求","depth":2},{"id":"响应.html","name":"响应.md","title":"响应","depth":2}]},{"id":"异常处理.html","name":"异常处理.md","title":"异常处理","depth":1},{"id":"数据库.html","name":"数据库.md","title":"数据库","depth":1,"children":[{"id":"数据库配置.html","name":"数据库配置.md","title":"数据库配置","depth":2},{"id":"查询构造器.html","name":"查询构造器.md","title":"查询构造器","depth":2},{"id":"模型.html","name":"模型.md","title":"模型","depth":2},{"id":"Redis.html","name":"Redis.md","title":"Redis","depth":2}]}],"article":{"id":"查询构造器.html","name":"查询构造器.md","title":"查询构造器","content":"目录\n\n[TOC]\n\n数据库查询构造器为 SQL 的构造和执行提供了方便的接口。WorkerA 提供了一个好用的查询构造器，基于 PDO，支持链式操作。\n\n支持的数据库有 mysql、postgresql、sqlite，支持断线重连。\n\n## 获取结果\n\n获取结果的方法有：get，row，getList，count，sum，avg，max，min。参数等信息参考 [ConnectorInterface](https://github.com/wazsmwazsm/WorkerF/blob/master/src/WorkerF/DB/Drivers/ConnectorInterface.php)。\n\n### 获取结果集\n\ntable 方法用来指定查询的数据表。\n\nget 方法用来获取结果集，返回值是一个查询结果的数组。\n\n\n```php\n// SELECT * FROM test;\n$data = DB::connection('con1')->table('test')->get();\n```\n\n### 获取一行数据\n\nselect 方法用来指定要取的列，select('\\*\\') 代表取所有列 (此时 select 可以省略不写)。\n\nrow 方法用来获取一行数据。\n\n```php\n// SELECT id, name, age, score FROM test WHERE id = 10;\n$row = DB::connection('con1')\n\t\t->table('test')\n        ->select('id', 'name', 'age', 'score')\n        ->where('id', 10)\n        ->row();\n```\n\n### 获取一列\n\n有时候我们需要获得某一列的数据，这时 getList 方法就派上用场了，getList 方法直接返回该列值的数组。\n\n```php\n// 获取 name 字段的结果集\n// SELECT name FROM test;\n$data = DB::connection('con1')->table('test')->getList('name');\n```\n\n### 聚合函数\n\n查询构造器为获取聚合函数的结果做了封装，你可以使用 count，sum 等方法获取聚合数据。\n```php\n// 获取查询结果的条数\n// SELECT COUNT(*) FROM test;\n$data = DB::connection('con1')->table('test')->count(*);\n// 获取 score 的总和\n// SELECT SUM(score) FROM test;\n$data = DB::connection('con1')->table('test')->sum('score');\n```\n\n## where 子句\n\n构建 where 子句的方法有 where、orWhere。\n\nwhere 、orWhere 方法的参数支持三种模式：\n\n- where(['name' => 'mike', 'age' => 18])\n- where('age', 24)\n- where('score', '>=', 60)、where('tag', 'like', '%php%')\n\n一些常用的例子：\n```php\n// SELECT * FROM test WHERE name = 'mike' AND age = 18;\n$data = DB::connection('con1')\n\t\t->table('test')\n        ->where([\n        \t'name' => 'mike', \n            'age' => 18\n        ])\n        ->get();\n\n// SELECT * FROM test WHERE name = 'jack' AND age >= 18;\n$data = DB::connection('con1')\n\t\t->table('test')\n        ->where('name', 'jack')\n        ->where('age', '>=',  18)\n        ->get();\n// SELECT * FROM test WHERE name = 'jack' OR name = 'mike';\n$data = DB::connection('con1')\n\t\t->table('test')\n        ->where('name', 'jack')\n        ->orWhere('name', 'mike')\n        ->get();\n```\n\n对于 null 的条件查询，查询构造器提供了 whereNull、whereNotNull 等方法：\n\n```php\n// SELECT * FROM test WHERE name IS NOT null;\n$data = DB::connection('con1')\n\t\t->table('test')\n        ->whereNotNull('name')\n        ->get();\n```\n\n> 注：where is null 子句的构造提供 whereNull、orWhereNull、whereNotNull、orWhereNotNull 四个方法。\n\n\nwhere between 子句：\n\n```php\n// SELECT * FROM test WHERE age BETWEEN 18 AND 30;\n$data = DB::connection('con1')\n\t\t->table('test')\n        ->whereBetween('age', 18, 30)\n        ->get();\n```\n\n> 注：where between 子句的构造提供 whereBetween、orWhereBetween 个方法。\n\nwhere in 子句：\n```php\n// SELECT * FROM test WHERE age IN (18, 19, 20);\n$data = DB::connection('con1')\n\t\t->table('test')\n        ->whereIn('age', [18, 19, 20])\n        ->get();\n```\n\n> 注：where in 子句的构造提供 whereIn、orWhereIn、whereNotIn、orWhereNotIn 四个方法。\n\n## 复杂 where 子句\n\nwhere exists 子句：\n```php\n// SELECT * FROM user WHERE EXISTS ( SELECT * FROM user_group WHERE id = 3 ) AND g_id = 3;\n$data = DB::connection('con1')\n\t\t->table('user')\n        ->whereExists(function($query) {\n            $query->table('user_group')->where('id', 3);\n        })\n        ->where('g_id', 3)\n        ->get();\n```\n\n> 注：where exists 子句的构造提供 whereExists、orWhereExists、whereNotExists、orWhereNotExists 四个方法。\n\nwhere in 子查询：\n```php\n// SELECT * FROM user WHERE g_id IN (SELECT id FROM user _group);\n$data = DB::connection('con1')\n\t\t->table('user')\n        ->whereInSub('g_id', function($query) {\n            $query->table('user_group')->select('id');\n        })\n        ->get();\n```\n\n> 注：where in 子查询的构造提供 whereInSub、orWhereInSub、whereNotInSub、orWhereNotInSub 四个方法。\n\n对于复杂的 where 逻辑，我们经常使用圆括号来确定优先级。查询构造器提供了 whereBrackets() 和 orWwhereBrackets() 方法来添加圆括号。\n\n```php\n// SELECT * FROM user WHERE (id < 50 OR username IS NOT NULL) AND sort_num = 20;\n$data = DB::connection('con1')\n        ->table('user')\n        ->whereBrackets(function($query) {\n            $query->where('id', '<', 50)\n                  ->orWhereNotNull('username');\n        })\n        ->where('sort_num', 20)\n        ->get();\n        \n// SELECT * FROM user WHERE sort_num = 20 OR (id < 10 AND id > 5);\n$data = DB::connection('con1')\n        ->table('user')\n        ->where('sort_num', 20)\n        ->orWhereBrackets(function($query) {\n            $query->where('id', '<', 10)\n                  ->where('id', '>', 5);\n        })\n        ->get();\n```\n\n## 子查询\n\n查询构造器提供了 fromSub 方法进行子查询：\n```php\n// SELECT id, username, email FROM ( SELECT * FROM user WHERE id < 20 ) AS tb;\n$data = DB::connection('con1')\n\t\t->select('id', 'username', 'email')\n        ->fromSub(function($query) {\n            $query->table('user')->where('id', '<', '20');\n        })\n        ->get();\n```\n\n\n## 分组\n\n查询构造器提供了 group 方法对字段进行分组，having (orHaving) 方法进行分组条件筛选。\n\nhaving 方法和 where 方法一样支持三种参数模式，这里就不再赘述。\n\n```php\n// SELECT sort_num, COUNT(sort_num) FROM user GROUP BY sort_num;\n$data = DB::connection('con1')\n\t\t->table('user')\n        ->select('sort_num', 'COUNT(sort_num)')\n        ->groupBy('sort_num')\n        ->get();\n        \n// SELECT sort_num, COUNT(sort_num) FROM user GROUP BY sort_num HAVING COUNT(sort_num) < 20;\n$data = DB::connection('con1')\n        ->table('user')\n        ->select('sort_num', 'COUNT(sort_num)')\n        ->groupBy('sort_num')\n        ->having('COUNT(sort_num)', '<', 20)\n        ->get();\n```\n\n查询构造器还提供了一个输入原生字符串的 havingRaw 方法，可以处理一些复杂的情况：\n```php\n// SELECT sort_num, COUNT(sort_num) FROM user GROUP BY sort_num HAVING COUNT(sort_num) < 20;\n$data = DB::connection('con1')\n\t\t->table('user')\n        ->select('sort_num', 'COUNT(sort_num)')\n        ->groupBy('sort_num')\n        ->havingRaw('COUNT(sort_num) < 20')\n        ->get();\n```\n\n## 排序\n\n查询构造器提供了 orderBy 方法对查询结果排序：\n```php\n// SELECT * FROM user ORDER BY sort_num DESC, id ASC;\n$data = DB::connection('con1')\n\t\t->table('user')\n        ->orderBy('sort_num', 'DESC')\n        ->orderBy('id', 'ASC')\n        ->get();\n```\n\n## limit\n\n查询构造器提供了 limit 方法来取一定范围的数据：\n```php\n// SELECT * FROM user LIMIT 10 OFFSET 3\n$data = DB::connection('con1')\n\t\t->table('user')\n        ->limit(3, 10)\n        ->get();\n```\n\n## 分页\n\n查询构造器提供了 paginate 方法实现了数据的分页读取，底层基于 limit 方法。\n\n假设有 35 条数据，每页有 10 条数据，我们取第 2 页的数据，做如下查询：\n\n```php\n$data = DB::connection('con1')\n\t\t->table('user')\n        ->paginate(10, 2);  // 每页 10 条数据，当前第 2 页\n```\n\npaginate 方法返回结果：\n```php\n[\n\t'total'        => 35;\n    'per_page'     => 10;\n    'current_page' => 2;\n    'next_page'    => 3;\n    'prev_page'    => 1;\n    'first_page'   => 1;\n    'last_page'    => 4;\n    'data'         => $yourdata;\n]\n```\n\n\n## 关联\n\n查询构造器提供了 join、leftJoin、rightJoin 三个方法来实现关联查询的构造。\n\n> 注：\n> 使用关联查询后，防止字段重名字段需要带表前缀。\n> sqlite 不支持 RIGHT JOIN 语言，rightJoin 方法在 sqlite 中不生效。\n\n一些例子：\n```php\n// SELECT * FROM user INNER JOIN user_group ON user.g_id = user_group.id;\n$data = DB::connection('con1')\n\t\t->table('user')\n        ->join('user_group', 'user.g_id', 'user_group.id')\n        ->get();\n        \n        \n// SELECT user.username, user_group.groupname FROM user LEFT JOIN user_group ON user.g_id = user_group.id;\n$data = DB::connection('con1')\n\t\t->table('user')\n        ->select('user.username', 'user_group.groupname')\n        ->leftJoin('user_group', 'user.g_id', 'user_group.id')\n        ->get();\n```\n\n## 构造复杂的语句\n\n查询构造器提供了灵活的接口，有了上面的基础，我们现在构造一些复杂的查询：\n\n```php\n// SELECT user.username, user_group.groupname FROM user \n// LEFT JOIN user_group ON user.g_id = user_group.id \n// WHERE username = 'Jackie aa' \n// OR ( NOT EXISTS ( SELECT * FROM user WHERE username = 'Jackie aa' ) AND username = 'Jackie Conroy' );\n$data = DB::connection('con1')\n\t\t->table('user')\n        ->select('user.username', 'user_group.groupname')\n        ->leftJoin('user_group', 'user.g_id', 'user_group.id')\n        ->where('user.username', 'Jackie aa')\n        ->orWhereBrackets(function($query) {\n            $query->whereNotExists(function($query) {\n                $query->table('user')->where('username', 'Jackie aa');\n            })->where('user.username', 'Jackie Conroy');\n        })\n        ->get();\n\n// SELECT user.sort_num, COUNT(*) FROM user \n// INNER JOIN user_group ON user.g_id = user_group.id \n// WHERE user.activated <> 0 \n// GROUP BY user.sort_num \n// HAVING user.sort_num = 20 OR user.sort_num = 50 ORDER BY user.sort_num DESC;\n$data = DB::connection('con1')\n\t\t->table('user')\n        ->select('user.sort_num', 'COUNT(*)')\n        ->join('user_group', 'user.g_id', 'user_group.id')\n        ->where('user.activated', '<>', 0)\n        ->groupBy('user.sort_num')\n        ->having('user.sort_num', '50')\n        ->orHaving('user.sort_num', '20')\n        ->orderBy('user.sort_num', 'DESC')\n        ->get();\n\n// SELECT user.username, user_group.groupname, company.companyname FROM company \n// LEFT JOIN user_group ON user_group.c_id = company.id \n// LEFT JOIN user ON user.g_id = user_group.id \n// ORDER BY user.sort_num ASC, user.id DESC LIMIT 25 offset 10;\n$data = DB::connection('con1')\n\t\t->table('user')\n        ->select('user.username', 'user_group.groupname', 'company.companyname')\n        ->leftJoin('user_group', 'user_group.c_id', 'company.id')\n        ->leftJoin('user', 'user.g_id', 'user_group.id')\n        ->orderBy('user.sort_num', 'ASC')\n        ->orderBy('user.id', 'DESC')\n        ->limit(10, 25)\n        ->get();\n        \n// SELECT * FROM user \n// WHERE username = 'Jackie aa' \n// OR ( NOT EXISTS ( SELECT * FROM user WHERE username = 'Jackie aa' ) AND (username = 'Jackie Conroy' OR username = 'Jammie Haag') ) \n// AND g_id IN ( SELECT id FROM user_group) ORDER BY id DESC LIMIT 1 OFFSET 0 ;\n$data = DB::connection('con1')\n\t\t->table('user')\n        ->where('username', 'Jackie aa')\n        ->orWhereBrackets(function($query) {\n            $query->whereNotExists(function($query) {\n                $query->table('user')->where('username', 'Jackie aa');\n            })->WhereBrackets(function($query) {\n                $query->where('username', 'Jackie Conroy')\n                      ->orWhere('username', 'Jammie Haag');\n            });\n        })\n        ->whereInSub('g_id', function($query) {\n            $query->table('user_group')->select('id');\n        })\n        ->orderBy('id', 'DESC')\n        ->limit(0, 1)\n        ->get();\n```\n\n## DML 语句\n\n除了基本的查询，查询构造器还提供了基础的 DML 操作，如插入、跟新、删除。\n\n### 插入\n\ninsert 方法：\n```php\n// INSERT INTO user (id, name, age) VALUES (5, 'jack', 18)\n$insert_data = [\n  'id'   => 5,\n  'name' => 'jack',\n  'age'  => 18,\n];\n// 默认返回受影响行数\n$effect_row = DB::connection('con1')->table('user')->insert($insert_data);\n```\n\n获取插入 ID，insertGetLastId 方法：\n\n```php\n// INSERT INTO user (id, name, age) VALUES (5, 'jack', 18)\n$insert_data = [\n  'id'   => 5,\n  'name' => 'jack',\n  'age'  => 18,\n];\n// 默认插入行的 id\n$effect_row = DB::connection('con1')->table('user')->insertGetLastId($insert_data);\n```\n\n### 更新\n\nupdate 方法。\n\n> 注：为了安全考虑，update 方法必须要和 where 子句一起使用，否则会抛出 InvalidArgumentException 异常。\n\n```php\n//  UPDATE user SET name = 'mike', age = 23 WHERE name = 'jack';\n$update_data = [\n  'name' => 'mike',\n  'age'  => 23,\n];\n// 默认返回受影响行数\n$effect_row = DB::connection('con1')\n\t\t->table('user')\n        ->where('name', 'jack')\n        ->update($update_data);\n```\n\n## 删除\n\ndelete 方法。\n\n> 注：为了安全考虑，delete 方法必须要和 where 子句一起使用，否则会抛出 InvalidArgumentException 异常。\n\n```php\n// DELETE FROM user WHERE id = 1;\n$effect_row = DB::connection('con1')\n\t\t->table('user')\n        ->where('id', 1)\n        ->delete();\n```\n\n## 事务\n\n查询构造器提供了 beginTrans、commitTrans、rollBackTrans 三个方法来支持事务：\n\n事务回滚：\n```php\n// 开始事务\nDB::connection('con1')->beginTrans();\n// DML 操作\nDB::connection('con1')\n\t\t->table('user')\n        ->where('id', 1)\n        ->delete(); \n回滚事务\nDB::connection('con1')->rollBackTrans();\n```\n\n提交事务：\n\n```php\n// 开始事务\nDB::connection('con1')->beginTrans();\n// DML 操作\nDB::connection('con1')\n\t\t->table('user')\n        ->where('id', 1)\n        ->delete(); \n提交事务\nDB::connection('con1')->commitTrans();\n```"},"options":{"plugins_host":null,"context":"website","base":"./","features":["search","internal_link"]},"style":""}</script><script type="text/javascript">kancloud.bootstrap();</script></body></html>